rule EternalBlue_domain : EternalBlue
{
    meta:
        author = "w-devin<Mr.wyw@foxmail.com>"
        description = "domains of EternalBlue"
        date = "2020-10-30"
    strings:
        $url_1 = "d.ackng.com"
        $url_2 = "t.amynx.com"
    condition:
        any of them
}

rule EternalBlue_7p_php : EternalBlue
{
    meta:
        author = "w-devin<Mr.wyw@foxmail.com>"
        description = "7p.php of EternalBlue, downloader and runner of ipc.jsp/ipco.jsp"
        date = "2020-10-30"
    strings:
        $reg_match = "[regex]::matches" nocase
        $separator = "'+'"
        $join = "-join" nocase
        $matcher = "'rIg'+'HtTO'+'le'+'FT'" nocase  // strong rule, may delete
    condition:
        all of them
}

rule EternalBlue_powershell : EternalBlue
{
    meta:
        author = "w-devin<Mr.wyw@foxmail.com>"
        description = "EternalBlue windows scripts"
        date = "2020-10-30"
    strings:
        $iex = /i`*e`*x/ nocase
        $confusion_1 = "IO.StreamReader" nocase
        $confusion_2 = "IO.Compression.DeflateStream" nocase
        $confusion_3 = "IO.MemoryStream" nocase
        $confusion_4 = "[convert]::ToUInt32($_,16)"
        $confusion_5 = "[IO.Compression.CompressionMode]::Decompress"
        $confusion_6 = "[Text.Encoding]::ASCII)"
        //$uint32_code = /[a-z0-9]{20,}/ //close for performance
    condition:
        //$iex and $uint32_code and 2 of ($confusion_*)
        $iex and 2 of ($confusion_*)
}

// smb brute force
rule EternalBlue_ipc_jsp : EternalBlue
{
    meta:
        author = "w-devin<Mr.wyw@foxmail.com>"
        description = "EternalBlue windows scripts, ipc.jsp/ipco.jsp"
        date = "2020-10-30"
    strings:
        $ipc = "'ipc'" nocase
        $ipco = "'ipco'" nocase
    condition:
        EternalBlue_powershell and any of them
}

//smb ghost
rule EternalBlue_smgh_jsp : EternalBlue
{
    meta:
        author = "w-devin<Mr.wyw@foxmail.com>"
        description = "EternalBlue windows scripts, smgh.jsp/smgho.jsp"
        date = "2020-10-30"
    strings:
        $smgh = "'smgh'" nocase
        $smgho = "'smgho'" nocase
    condition:
        EternalBlue_powershell and any of them
}

//usb
rule EternalBlue_usb_jsp : EternalBlue
{
    meta:
        author = "w-devin<Mr.wyw@foxmail.com>"
        description = "EternalBlue windows scripts, usb.jsp"
        date = "2020-10-30"
    strings:
        $usb = "'usb'" nocase
    condition:
        EternalBlue_powershell and any of them
}

//mssql
rule EternalBlue_ms_jsp : EternalBlue
{
    meta:
        author = "w-devin<Mr.wyw@foxmail.com>"
        description = "EternalBlue windows scripts, ms.jsp, mso.jsp, if.bin"
        date = "2020-11-06"
    strings:
        $ms = "'ms'" nocase
        $mso = "'mso'" nocase
    condition:
        EternalBlue_powershell and any of ($ms*)
}

//a.asp
rule High_suspicious_bash : EternalBlue
{
    meta:
        author = "w-devin<Mr.wyw@foxmail.com>"
        description = "linux scripts, suspicious"
        date = "2020-11-06"
    strings:
        $kill_process_1 = "kill -9"
        $kill_process_2 = "killall"
        $kill_process_3 = "pkill -f"
        $close_service_1 = "systemctl stop"
        $close_service_2 = "systemctl disable"
        $delete_folders = "rm -rf"
        $vis_know_hosts = ".ssh/known_hosts"
        $vis_rsa_pub = ".ssh/id_rsa.pub"
        $down_file_1 = "curl -fsSL"
        $down_file_2 = "wget "
        $run_script_from_mem = /\|\s?bash/
        $crontab_opr = "crontab -"
        $clear_history = "echo > /root/.bash_history"
        $clear_log = "echo > /var/log/"
    condition:
        3 of them
}

rule EternalBlue_shell : EternalBlue
{
    meta:
        author = "w-devin<Mr.wyw@foxmail.com>"
        description = "EternalBlue linux scripts, a.asp, core.png"
        date = "2020-11-06"
    condition:
        High_suspicious_bash and EternalBlue_domain
}

//if.bin todo
//if_mail.bin todo
//a.jsp todo