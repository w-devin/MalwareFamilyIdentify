# MalwareFamilyIdentify

恶意软件家族样本识别


## 2020-10-24 01:26:00

说实话, 到我创建这个仓库的时候, 这个 detector 应该是什么样子并没有想好
但是心里一直觉着, 作为网络/系统安全防的一方, 应当有相对主动的捕获能力才对

这个项目当前本质上更像是一个基于yara的文件检测引擎, 是我某个计划的子集, 目的有二:

前期计划实现的功能:

1. 主机失陷状态判断
2. 样本收集

目前认为它未来应该有的能力有:

1. 衍生样本识别(简单规则/ML)
2. 文件检测 + 终端日志 + 流量 三特征匹配

项目本身为 python2.7, 这是受其运行环境限制的, hhhhhhh, 尽量写得兼容性好一些


目前还没有想好具体怎么做, 但是 just do it， 项目不大, 顶多一次重构

因为是对每个样本比较底层的分析, 即使有很多行业大佬的文章作为参考, 仅我一人之力更新可能比较慢, 但是 just do it!

## 2020-11-06 10:48

11月1日去石家庄出差了, 延误了近一周...今天终于把永恒之蓝的规则写完

手里又攒了几个样本, 可惜都是shell或powershell的, 

想搞几个二进制样本玩玩, 目测要花很多时间, 慢慢更吧, 来日方长

## 踩坑记录

1. invalid field name "md5"

[reference](https://github.com/TheHive-Project/Cortex-Analyzers/issues/62)

```shell
sudo apt install libssl-dev && sudo pip install -I yara-python
```

2. about hash.md5

原本想写的优雅一些, 类似于

```yara
import "hash"

rule test : coder
{
    meta:
        author = "w-devin<Mr.wyw@foxmail.com>"
        description = "DESCRIPTION"
        thread_level = 0
        reference = "REFERENCE"
    strings:
        $hash_1 = "10b58b0ec6494c895e25b04628c34e2b"
        $hash_2 = "30220c69c2a6232b91685217d83ff17e"
    condition:
        hash.md5(0, filesize) in ($hash_*)
}
```

emmmmmm, 理所当然的不支持了, yara 的 `in` 作用为指定地址或偏移地址

然后使用 `for any of`

```yara
import "hash"

rule test : coder
{
    meta:
        author = "w-devin<Mr.wyw@foxmail.com>"
        description = "DESCRIPTION"
        thread_level = 0
        reference = "REFERENCE"
    strings:
        $hash_1 = "10b58b0ec6494c895e25b04628c34e2b"
        $hash_2 = "30220c69c2a6232b91685217d83ff17e"
    condition:
        for any of ($*) : (hash.md5(0, filesize) == $)
}
```
并不行, 据我推测, `hash.md5` 只能与字符串常量比较, 不能为变量, 从[github](https://github.com/search?l=&p=1&q=hash.md5+language%3AYARA&type=Code)和[vt的规则仓库](https://github.com/Yara-Rules/rules)均只能找到下面这种写法

```yara
import "hash"

rule test : coder
{
    meta:
        author = "w-devin<Mr.wyw@foxmail.com>"
        description = "DESCRIPTION"
        thread_level = 0
        reference = "REFERENCE"
    condition:
        hash.md5(0, filesize) == "30220c69c2a6232b91685217d83ff17e"
}
```
emmmmm