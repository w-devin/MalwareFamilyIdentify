rule powershell : POWERSHELL
{
    meta:
        author = "w-devin<Mr.wyw@foxmail.com>"
        description = "some base rule for powershell"
        date = "2020-11-09"
        reference = "None"
    strings:
        $cmd_1 = "cmd" nocase wide ascii
        $cmd_2 = "powershell" nocase wide ascii
    condition:
        any of them
}

rule iex : POWERSHELL
{
    meta:
        author = "w-devin<Mr.wyw@foxmail.com>"
        description = "no compiler, so collect from samples"
        date = "2020-11-09"
        reference = "None"
    strings:
        $idx_1 = /i`?e`?x/ nocase wide ascii
        $idx_2 = "Invoke-Expression" nocase wide ascii
        $shellid_1 = "$ShELliD[1]+$ShELLiD[13]+'X'" nocase wide ascii //in3.ps1
    condition:
        any of them
}

rule bypass_params : POWERSHELL
{
    meta:
        author = "w-devin<Mr.wyw@foxmail.com>"
        description = "uac bypass"
        date = "2020-11-09"
        reference = "None"
    strings:
        $bypass_0 = "-nop" nocase wide ascii
        $bypass_1 = "-Noprofile" nocase wide ascii
        $bypass_2 = "-w hidden" nocase wide ascii
        $bypass_3 = "-WindowStyle hidden" nocase wide ascii
        $bypass_4 = "-Exec Bypass" nocase wide ascii
        $bypass_5 = "-Command" nocase wide ascii
        $bypass_6 = "-c" nocase wide ascii
        $bypass_7 = "-EncodedCommand" nocase wide ascii
        $bypass_8 = "-e" nocase wide ascii
        $bypass_9 = "-Enc" nocase wide ascii
    condition:
        any of them
}

rule string_opr : POWERSHELL
{
    meta:
        author = "w-devin<Mr.wyw@foxmail.com>"
        description = "about encoding"
        date = "2020-11-10"
        reference = "None"
    strings:
        $replace = "replace" nocase wide ascii
        $string_opr_1 = "[System.Text.Encoding]" nocase wide ascii
        $string_opr_2 = "[System.Convert]::FromBase64String" nocase wide ascii
        $string_opr_3 = "[Convert]::toint" nocase wide ascii
        $string_opr_4 = "join" nocase wide ascii
        $string_opr_5 = "split" nocase wide ascii
        $string_opr_6 = "'+'"
        $string_opr_7 = "System.IO.MemoryStream" nocase wide ascii
        $string_opr_8 = "System.IO.StreamReader" nocase wide ascii
        $string_opr_9 = "System.IO.Compression" nocase wide ascii
        $string_opr_10 = "[Math]::Floor" nocase wide ascii
        $string_opr_11 = "substring" nocase wide ascii
        $string_opr_12 = "[Regex]::Matches" nocase wide ascii
        $string_opr_13 = "[array]::reverse" nocase wide ascii
    condition:
        any of them
}

rule sus_behavior : POWERSHELL
{
    meta:
        author = "w-devin<Mr.wyw@foxmail.com>"
        description = "some high suspicious behaviour"
        date = "2020-11-10"
        reference = "None"
    strings:
        $wmi_1 = "Get-WMIObject" nocase wide ascii
        $wmi_2 = "gwmi" nocase wide ascii
    condition:
        any of them
}

rule downloader : POWERSHELL
{
    meta:
        author = "w-devin<Mr.wyw@foxmail.com>"
        description = "about downloader"
        date = "2020-11-10"
        reference = "None"
    strings:
        $download_1 = "DownloadFile" nocase wide ascii
        $download_2 = "DownloadString" nocase wide ascii
    condition:
        any of them
}
